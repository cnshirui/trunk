ROR实例－采集新浪博客 - Ruby on Rails - Ruby中文社区论坛 _非官方网站 - Ruby, Ruby on Rails, ROR论坛, ROR社区,Rails论坛,Rails社区,Ruby论坛,Ruby社区 - Powered by Discuz!
      在 @ruby-lang.org.cn 中获取一个免费的电子邮件帐户
注册 检查电子邮件 
cnshirui: 退出 | 短消息 | 会员 | 搜索 | 奖励 | 我的 | 控制面板 | 道具 | 帮助 

Ruby中文社区论坛 &raquo; Ruby on Rails &raquo; ROR实例－采集新浪博客
      [招蓦应用程序中文化版块版主及小组成员] [希望大家加入社区开源项目]

      &#8249;&#8249; 上一主题 | 下一主题 &#8250;&#8250;

      打印 | 推荐 | 订阅 | 收藏 标题: ROR实例－采集新浪博客
      本主题由 skyover 于 2007-6-22 00:09 移动 

 skyover 

      网站管理员




        
      UID 1
      精华 0
      积分 469
      帖子 809
      R币 64 
      贡献 52 
      阅读权限 200
      注册 2007-6-6
      状态 在线 #1使用道具 发表于 2007-6-22 00:07 资料 个人空间 短消息 加为好友 

            ROR实例－采集新浪博客


            正好这周在用ruby重写以前用php写的新闻采集程序,就顺手做一个小小的实例罢.简单了些,希望能对新接触ruby的朋友有些微帮助.

            基本流程:

              从新浪博客首页取得当前被推荐的博客列表,写入数据库 
              从数据库内读取未被采集的博客列表,依次采集 
              重复执行以上两步 

            开始之前的准备:

              建立rails工作环境; 
              建立两个Model 
              $ ruby script/generate model resource
              $ ruby script/generate model artikel

              建立数据表 
              create_table :resources do |t|
              t.column :title, :string
              t.column :url, :string
              t.column :clawed, :integer,:limit=>1
              end
              create_table :artikels do |t|
              t.column :title, :string
              t.column :url, :string
              t.column :author, :string
              t.column :uid, :string
              t.column :body, :text
              t.column :views, :integer
              t.column :created_at, :datetime
              end

            采集:
            现在进入正题

            我们需要新建一个model

              $ ruby script/generate mail claw
              #之所以用mail model,因为这个实例一开始是写来收pop3邮件的,这个不重要.

            编辑app/models/claw.rb
              require 'open-uri' #打开远程文件需要载入open-uri

            读取目标地址

              def self.getitemlist
              siteurl = open('http://blog.sina.com.cn/main/')
              xhtml = siteurl.read
              ……
              end

            分析链接,分析页面内所有类如<a href="http://blog.sina.com.cn/u/46eacfc9010006hl" 
            title="" target="_blank">中国当代作家的自卑情节</a>的字串,
            并分别取得标题中国当代作家的自卑情节和目标地址46eacfc9010006hl 
              xhtml.gsub(/<a 
              href=\"http:\/\/blog.sina.com.cn\/u\/(\w{16})\"(?:[^>]+)>(.+?)<\/a>/){|m|
              ……
              #Regexp.last_match[2] #中国当代作家的自卑情节
              #Regexp.last_match[1] #46eacfc9010006hl
              }

            写入数据库

              xhtml.gsub(/<a 
              href=\"http:\/\/blog.sina.com.cn\/u\/(\w{16})\"(?:[^>]+)>(.+?)<\/a>/){|m|
              if Resource.find_by_url(Regexp.last_match[1]).nil? #url重复判断
              @resource = Resource.new
              @resource[:title] = Regexp.last_match[2]
              @resource[:url] = Regexp.last_match[1]
              @resource.save
              end
              }

            现在我们来采集具体的blog文章

              def self.getcontent
              while @resource=Resource.find(:first, :conditions => ["clawed = 
              ?",nil])
              xhtml = open('http://blog.sina.com.cn/u/'+@resource.url).read
              ……
              end
              end

            分析采集到的内容.作为一个小演示,偷个懒,直接把目标内容剔除所有html标签

              xhtml = 
              xhtml.sub(%r{<body.*?>(.*?)</body>}mi, '\1').gsub(/<.*?>/m, ' ').
              gsub(%r{(\n\s*){2}}, "\n\n")

            得到像这样的文本

              中国当代作家的自卑情节- 残雪 - 新浪BLOG var THEME = '1';
              var UID = '1189793737';
              var AUTHOR = '残雪'; BROWSER == "ie5" ? dw(' ') : dw(' '); 残雪的BLOG 
              http://blog.sina.com.cn/m/canxue  复制 收藏本页 HOME 残雪的BLOG 我的文章分类 ■ 
              我的所有文章 
              发表文章
              中国当代作家的自卑情节 2006-12-15 09:13:56 大 中 小 
              我认为当代文学有不有希望，同我们接受西方文化，向西方经典学习的程度是同步的。不可否认，80年代至90年代，大家都写过一些好东西。但拿到今天来看，那种“好”是很有限的，无论是情感积累还是文化积累都很稀薄。我这里所说的文……当然竞赛的前提是承认文学有一个共同的标准，承认人性是可以相通的，作品是可以产生共鸣的。

              评论(72) ┆ 引用 ┆ 阅读(6512) ┆ 圈子

            现在来分析这个文本,取出uid,author,title,正文,发表时间和阅读次数

              xhtml.gsub(/\s+(.+?)- (\S+) - 新浪BLOG(?:[\s\S]+)UID = 
              '(\d{10})'(?:[\s\S]+)AUTHOR = '(\S+)'(?:[\s\S]+)(\d{4}-\d{2}-\d{2} 
              \d{2}:\d{2}:\d{2})(?:\s+)大 中 
              小(?:\s+)([\s\S]+)(?:\s+)(?:评论)*(?:[\s\S]+)阅读\((\d{1,})\)/){|m|
              @artikel = Artikel.new
              @artikel[:title] = Regexp.last_match[1]
              @artikel[:url] = @resource.url
              @artikel[:author] = Regexp.last_match[2]
              @artikel[:uid] = Regexp.last_match[3]
              @artikel[:created_at] = Regexp.last_match[5]
              @artikel[:body] = Regexp.last_match[6]
              @artikel[:views] = Regexp.last_match[7]
              if @artikel.save
              puts 'item down!' if @resource.update_attribute('clawed',1) 
              #标记已采集过的链接
              end
              }

            流程

              def self.clean
              loop do
              getitemlist #从首页取得列表
              getcontent #依次取回文章内容
              sleep (60*5) #休息5分钟
              end
              end


            最后:
            $ ruby script/runner Claw.clean 


            转摘自落伍，作者：muzik



            报告 评分  
            [广告] R币下完了？来看［赚取R币的三种方式吧］

      skyover 

      网站管理员




        
      UID 1
      精华 0
      积分 469
      帖子 809
      R币 64 
      贡献 52 
      阅读权限 200
      注册 2007-6-6
      状态 在线 #2使用道具 发表于 2007-6-22 11:09 资料 个人空间 短消息 加为好友 
            我还没写过一个东西出来。呵呵。准备拿个留言本练练手。^_^



            报告 评分  
            [广告] R币下完了？来看［赚取R币的三种方式吧］

      mathsfan 

      初入江湖




      UID 7
      精华 0
      积分 9
      帖子 8
      R币 5 
      贡献 0 
      阅读权限 2
      注册 2007-6-15
      状态 离线 #3使用道具 发表于 2007-6-25 19:05 资料 个人空间 短消息 加为好友 
            有空试下这个例子，大概看了下，好象还算能看的懂，呵呵



            报告 评分  
            [广告] R币下完了？来看［赚取R币的三种方式吧］





      控制面板首页
      编辑个人资料
      积分交易
      公众用户组
      好友列表
      个人空间管理

      基本概况
      论坛排行
      主题排行
      发帖排行
      积分排行
      交易排行
      在线时间
      管理团队
      管理统计

      我的话题
      我的收藏
      我的订阅
      我的权限
      我的交易
      我的悬赏
      我的活动
      我的推广
      个人空间


当前时区 GMT+8, 现在时间是 2007-7-23 23:09

        Powered by Discuz! 5.5.0 &copy; 2001-2007 Comsenz Inc. 
      Processed in 0.108910 second(s), 7 queries , Gzip enabled TOP
      清除 Cookies - 联系我们 - Ruby中文网站 - Archiver - WAP 

我要统计  2007-07-23 23:09 Crawled by Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 
5.1; Maxthon; .NET CLR 2.0.50727) @124.78.102.216 